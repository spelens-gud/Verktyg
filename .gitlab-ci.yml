variables:
  TEST_ARGS: ""
  GOPATH: /cache/go/
  GOMODCACHE: /cache/go/pkg/mod
  GOCACHE: /cache/go/build
  GOSUMDB: "off"
  FMTCMD: "gofmt -w -l ./"
  LINT_CMD: "golangci-lint run --allow-parallel-runners=true --timeout=5m"
  GO_BUILD_IMAGES: go124:v0.0.1
  RM_GENERATED_CODE: '(grep -l -r "// Code generated by .* DO NOT EDIT." ./* | grep ".go" | xargs -r rm) || true'

  SONAR_RUNNER_IMAGES: todo/sonar-scanner-46:v0.1.4

default:
  image: $GO_BUILD_IMAGES
  tags:
    - go-devops-runner

workflow:
  rules:
    - when: always

stages:
  - format
  - lint
  - sonar

format:
  interruptible: true
  stage: format
  script:
    - sh -c "$RM_GENERATED_CODE"
    - UNFMT=`sh -c "$FMTCMD"` && [ ! "$UNFMT" ] || (echo $UNFMT;echo "提交代码前请使用 [ $FMTCMD ]  格式化代码";exit 1)


lint:
  interruptible: true
  stage: lint
  allow_failure: true
  script:
    - go mod tidy
    - go mod download -x
    - $LINT_CMD --print-resources-usage ./... || $LINT_CMD --out-format checkstyle ./... > report.xml
  artifacts:
    when: on_failure
    expire_in: 300 mins
    paths:
      - report.xml



sonar:
  interruptible: true
  allow_failure: false
  rules:
    - if: $CI_MERGE_REQUEST_TARGET_BRANCH_NAME == $CI_DEFAULT_BRANCH
    - if: $CI_COMMIT_REF_PROTECTED == "true"
    - if: $CI_PIPELINE_SOURCE == "web"
  stage: sonar
  image: $SONAR_RUNNER_IMAGES
  variables:
    GIT_DEPTH: "2147483647"
  script:
    - \[ "${CI_MERGE_REQUEST_TARGET_BRANCH_NAME}" ] && git fetch origin  $CI_MERGE_REQUEST_TARGET_BRANCH_NAME || true
    - sh -c "$RM_GENERATED_CODE"
    - export PROJECT_NAME="$(echo $CI_PROJECT_NAMESPACE | sed "s/\//-:/g"):${CI_PROJECT_NAME}"
    - sh /init.sh
    - |
      sonar-scanner \
      -Dsonar.tests=./ \
      -Dsonar.test.inclusions=**/*_test.go \
      -Dsonar.test.reportPath=junit-report.xml \
      -Dsonar.go.golangci-lint.reportPaths=report.xml                            
