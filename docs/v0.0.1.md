# v0.0.1+ 重要说明

#### [配置加载器](../implements/cfgloader/acm.go) 重构

- 添加日志 更方便debug问题
- 提供 `NewConfigLoaderFromEnv` 自动适配大部分场景的`loader`
- 统一配置命名为`Config` 默认开发文件加载路径请使用 `config.lcoal.json`
- 删除大部分API 只保留 `Load(configRoot interface{}) (err error)` 方法 请更新后自行修改配置加载文件为

```go
package config

var cfgLoader = cfgloader.NewConfigLoaderFromEnv(
	// cfgloader.NewFileLoader("其他自定义配置目录"),
)

func LoadConfig() (config Config) { cfgLoader.MustLoad(&config); return }
```

#### [Http服务器运行框架](../kits/kserver/server.go) 重构

- 优雅重启
    - 自动判断环境 识别为服务器环境时 自动开启优雅信号监听
    - 分离优雅重启的信号监听逻辑 使得整个优雅重启模块更加独立
    - 优化子进程对父进程Kill的时机 并优化父进程等待子进程Kill时的处理 做到双向可复位 避免endless实现的只能触发一次
- 生命周期
    - 添加更多日志信息和标签 方便诊断
    - 使用[kruntime](../kits/kruntime/signal.go)包的信号通道进行统一信号管理 支持两次信号触发强制退出
    - 支持服务器首次建连事件广播
    - 根据服务器生命周期 自动将`logger`模块日志输出切换成异步模式

#### [Gin中间件](../kits/kserver/gin_middles) 部分重构

- [默认中间件链](../kits/kserver/gin_middles/default.go)
    - 将大多数可定制化功能抽离为Option 可通过传入Option进行自定义
    - 支持通过传入闭包Option或环境变量进行特定模块的开关
- [日志Log](../kits/kserver/gin_middles/log.go)
    - 支持自定义忽略日志的路由和状态码
    - 添加了`HTTP_SERVER`标签和应用名字段
    - 优化了性能表现
- [访问监控Metrics](../kits/kserver/gin_middles/metrics.go)
    - 删除了大部分冗余指标
- [熔断器Sentinel](../kits/kserver/gin_middles/sentinel.go)
    - 优化初始化时机
    - 支持通过环境变量`SERVER_SENTINEL_DISABLE`进行关闭

#### [HTTP客户端](../implements/httpreq) 重构

[示例](./example_httpreq/example_httpreq.go)

- 客户端支持添加固定请求配置 `WithRequestOptions(opts ...ihttp.ReqOpt) ihttp.Client`
- 统一参数封装逻辑 支持自定义参数处理客户端
- 优化埋点注入接口 能够快速注入到其他原生`http.Client`

#### [Gorm连接库](../implements/gormctx) 重构

[事务操作示例](./example_mysql/example_mysql.go)

- 监控优化
    - 使用 [sqlmw](https://github.com/ngrok/sqlmw) 库进行`driver`层植入
    - 分离监控相关模块为 [sqlcx](../implements/sqlcx)
    - 支持监控所有mysql客户端操作
- 日志优化
    - 添加`Gorm`兼容Logger 能将`Gorm`内置日志输出为JSON格式 默认开启
- 事务优化
    - 添加 `Transaction(ctx context.Context,f (txCtx context.Context,tx *gorm.DB) error) (err error)` 方法
      支持事务通过`context.Context`进行跨`Service`层传播
- 连接池优化
    - 使用`sync.Pool` 进行 `*gorm.DB` 自动复用 能够大量减少内存分配

#### [日志组件](../kits/klog/logger) 重构

[更强大的自定义日志处理API实例](./example_logger/example_logger.go)

- 架构优化
    - 拆分为 [internal](../kits/klog/logger/internal) 层 和 [api](../kits/klog/logger/api.go) 层
    - 全生命周期懒加载化 只有在首次调用时才会进行各层实例初始化
    - 统一封装逻辑 减少加入封装层时的性能损耗 支持自定义封装层
    - 优化对象复用 `logger.FromContext` 对比旧版本减少大部分对象创建
    - 比较复杂 有兴趣直接可以看代码
- API细节优化
    - 删除暴露大部分业务开发无关API
    - 减少非必要/冗余字段 精简日志内容 如只有一个`Tag`时的`Tags`
- 性能优化
    - 比旧版本提升约40%
- 异步流
    - 由[Http服务器运行框架](../kits/kserver/server.go)控制自动切换异步
    - 更改为使用`zapcore.BufferedWriteSyncer`方案 并支持旁路输出 在`Close`后自动切换回原输出流
- 日志字段
    - 为避免索引类型冲突 所有 `WithField` 和 `WithFields` 添加字段 key会自动添加 `.$type` 后缀 如 `WithField("pid",int(1))` 会转化为 `"pid.int":1`

#### [监控上报](../implements/promgateway) 优化

- 应用关闭后 按照上报周期 自动删除`pushgateway`的指标
- 优化日志输出
- 优化上报生命周期 支持更多初始化选项

#### [Kafka组件](../implements/skafka) 重构

[生产消费示例](./example_kafka/example_kafka.go)

- 添加[快速消费API](../implements/skafka/consumer.go) 更简易开启消费
- 添加[快速生产API](../implements/skafka/client.go) 更简易进行消息生产
- 生产者添加 `SendMessageX(ctx context.Context, topic, key string, value interface{}) (err error)` API 更易用
- 优化同步异步生产的批量生产`SendMessages`逻辑 真正和原生API实现一致的`SendMessages`
- 优化埋点回调 减少goroutine占用

#### [应用任务管理框架](../implements/worker) 重构

[Kafka生产消费进程示例](./example_kafka_workmanager/example_kafka_workmanager.go)

- 添加 `iworker.WorkerManager`接口和对应实现模块 支持管理定时任务、单个任务、阻塞任务
- 优化信号监听 更完美的优雅退出机制
- 优化管理调度日志
